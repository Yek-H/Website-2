{% comment %}
  Product Grid with Type (V3.1 - Fixed & Optimized)
  - Fixed: Removed missing 'badge-logic' snippet dependency.
  - Inlined badge logic for single-file ease of use.
{% endcomment %}

{%- liquid
  assign collection = collections[section.settings.collection]
  assign products_to_show = section.settings.products_to_show
  assign products_per_row = section.settings.products_per_row
  assign mobile_columns = section.settings.mobile_columns | plus: 0
  
  assign eager_limit = products_per_row
  if mobile_columns == 1
     assign eager_limit = 2
  endif

  capture sizes_attr
    echo '(min-width: 1400px) calc((1400px - 130px) / ' | append: products_per_row | append: '), '
    echo '(min-width: 1025px) calc((100vw - 130px) / ' | append: products_per_row | append: '), '
    echo '(min-width: 769px) calc((100vw - 100px) / 3), '
    if mobile_columns == 2
      echo 'calc((100vw - 55px) / 2)'
    else
      echo 'calc(100vw - 40px)'
    endif
  endcapture

  assign more_in_collection = false
  if collection.all_products_count > products_to_show
    assign more_in_collection = true
  endif
-%}

<style>
  .product-grid-section { padding: 60px 0; contain: content; }
  .page-width { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
  .section-heading { text-align: center; font-size: 32px; font-weight: 600; margin-bottom: 40px; color: #333; }
  .product-grid { display: grid; gap: 30px; list-style: none; padding: 0; margin: 0; }
  @media (min-width: 1025px) {
    .product-grid--desktop-2 { grid-template-columns: repeat(2, 1fr); }
    .product-grid--desktop-3 { grid-template-columns: repeat(3, 1fr); }
    .product-grid--desktop-4 { grid-template-columns: repeat(4, 1fr); }
    .product-grid--desktop-5 { grid-template-columns: repeat(5, 1fr); }
  }
  @media (max-width: 1024px) and (min-width: 769px) {
    .product-grid { grid-template-columns: repeat(3, 1fr); gap: 20px; }
  }
  .product-card { background: #fff; border-radius: 8px; overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease; border: 1px solid #e5e5e5; display: flex; flex-direction: column; contain: paint layout; }
  .product-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
  .product-card__link { text-decoration: none; color: inherit; display: flex; flex-direction: column; height: 100%; }
  .product-card__image-wrapper { position: relative; width: 100%; aspect-ratio: 4 / 5; background: #f5f5f5; overflow: hidden; }
  .product-card__image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
  .product-card:hover .product-card__image { transform: scale(1.04); }
  .product-card__info { padding: 20px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; }
  .product-card__title { font-size: 16px; font-weight: 600; margin: 0 0 8px 0; color: #333; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; min-height: 2.8em; }
  .product-card__type { font-size: 13px; margin: 0 0 12px 0; color: {{ section.settings.type_color | default: '#666' }}; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
  {% if section.settings.type_style == 'pill' %}
    .product-card__type { display: inline-block; background: {{ section.settings.type_bg_color | default: '#f5f5f5' }}; padding: 4px 12px; border-radius: 20px; font-size: 12px; align-self: center; }
  {% elsif section.settings.type_style == 'underline' %}
    .product-card__type { border-bottom: 2px solid {{ section.settings.type_color | default: '#666' }}; display: inline-block; padding-bottom: 2px; align-self: center; }
  {% endif %}
  .product-card__vendor { font-size: 12px; color: #999; margin: 0 0 12px 0; }
  .product-card__price { font-size: 18px; font-weight: 600; margin-top: auto; padding-top: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap; }
  .product-card__price--sale { color: #e63946; }
  .product-card__price--compare { color: #999; text-decoration: line-through; font-size: 14px; font-weight: 400; }
  .product-card__badges { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; z-index: 2; pointer-events: none; }
  .product-card__badges--image { position: absolute; top: 12px; right: 12px; flex-direction: column; align-items: flex-end; }
  .product-card__badges--top { margin-bottom: 12px; }
  .product-card__badges--bottom { margin-top: 12px; }
  .badge { display: inline-block; padding: 5px 10px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; line-height: 1; }
  .badge--sold-out { background: #333; color: #fff; }
  .badge--sale { background: #e63946; color: #fff; }
  .product-grid__view-all { text-align: center; margin-top: 40px; }
  @media (max-width: 768px) {
    .product-grid-section { padding: 40px 0; }
    .section-heading { font-size: 24px; margin-bottom: 24px; }
    .product-grid { gap: 15px; }
    .product-grid--mobile-1 { grid-template-columns: 1fr; }
    .product-grid--mobile-2 { grid-template-columns: repeat(2, 1fr); }
    .product-card__info { padding: 15px; }
    .product-card__title { font-size: 14px; min-height: 2.8em; }
    .product-card__price { font-size: 16px; }
  }
</style>

<div class="product-grid-section" data-section-id="{{ section.id }}">
  <div class="page-width">
    {%- if section.settings.heading != blank -%}
      <h2 class="section-heading">{{ section.settings.heading | escape }}</h2>
    {%- endif -%}

    <div class="product-grid product-grid--desktop-{{ products_per_row }} product-grid--mobile-{{ mobile_columns }}">
      {%- for product in collection.products limit: products_to_show -%}
        {%- liquid
          assign loading_strategy = 'lazy'
          assign fetch_priority = 'auto'
          if forloop.index <= eager_limit
             assign loading_strategy = 'eager'
             if forloop.index == 1
                assign fetch_priority = 'high'
             endif
          endif
        -%}
        
        <div class="product-card" {% if loading_strategy == 'lazy' %}style="content-visibility: auto; contain-intrinsic-size: 1px 400px;"{% endif %}>
          <a href="{{ product.url }}" class="product-card__link">
            <div class="product-card__image-wrapper">
              {%- if section.settings.show_badges and section.settings.badge_position == 'image' -%}
                 {%- if product.available == false or product.compare_at_price > product.price -%}
                  <div class="product-card__badges product-card__badges--image">
                    {%- if product.available == false -%}
                      <span class="badge badge--sold-out">{{ 'products.product.sold_out' | t | default: 'Sold out' }}</span>
                    {%- elsif product.compare_at_price > product.price -%}
                      <span class="badge badge--sale">{{ 'products.product.on_sale' | t | default: 'Sale' }}</span>
                    {%- endif -%}
                  </div>
                {%- endif -%}
              {%- endif -%}

              {%- if product.featured_image -%}
                {{ product.featured_image | image_url: width: 1000 | image_tag:
                  loading: loading_strategy,
                  fetchpriority: fetch_priority,
                  sizes: sizes_attr,
                  widths: '165, 360, 533, 720, 940, 1066',
                  class: 'product-card__image',
                  decoding: 'async',
                  alt: product.featured_image.alt | escape
                }}
              {%- else -%}
                <div class="product-card__image-placeholder" aria-hidden="true">
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                </div>
              {%- endif -%}
            </div>

            <div class="product-card__info">
              {%- if section.settings.show_badges and section.settings.badge_position == 'top' -%}
                 {%- if product.available == false or product.compare_at_price > product.price -%}
                  <div class="product-card__badges product-card__badges--top">
                    {%- if product.available == false -%}
                      <span class="badge badge--sold-out">{{ 'products.product.sold_out' | t | default: 'Sold out' }}</span>
                    {%- elsif product.compare_at_price > product.price -%}
                      <span class="badge badge--sale">{{ 'products.product.on_sale' | t | default: 'Sale' }}</span>
                    {%- endif -%}
                  </div>
                {%- endif -%}
              {%- endif -%}

              <h3 class="product-card__title">{{ product.title }}</h3>
              
              {%- if section.settings.show_product_type and product.type != blank -%}
                <p class="product-card__type">{{ product.type }}</p>
              {%- endif -%}
              {%- if section.settings.show_vendor and product.vendor != blank -%}
                <p class="product-card__vendor">{{ product.vendor }}</p>
              {%- endif -%}

              <div class="product-card__price">
                {%- if product.compare_at_price > product.price -%}
                  <span class="product-card__price--sale">{{ product.price | money }}</span>
                  <span class="product-card__price--compare">{{ product.compare_at_price | money }}</span>
                {%- else -%}
                  <span>{{ product.price | money }}</span>
                {%- endif -%}
              </div>

              {%- if section.settings.show_badges and section.settings.badge_position == 'bottom' -%}
                {%- if product.available == false or product.compare_at_price > product.price -%}
                  <div class="product-card__badges product-card__badges--bottom">
                    {%- if product.available == false -%}
                      <span class="badge badge--sold-out">{{ 'products.product.sold_out' | t | default: 'Sold out' }}</span>
                    {%- elsif product.compare_at_price > product.price -%}
                      <span class="badge badge--sale">{{ 'products.product.on_sale' | t | default: 'Sale' }}</span>
                    {%- endif -%}
                  </div>
                {%- endif -%}
              {%- endif -%}
            </div>
          </a>
        </div>
      {%- endfor -%}
    </div>

    {%- if section.settings.show_view_all and more_in_collection -%}
      <div class="product-grid__view-all color-{{ section.settings.view_all_color_scheme }}">
        <a href="{{ collection.url }}" class="{% if section.settings.view_all_style == 'link' %}link underlined-link{% elsif section.settings.view_all_style == 'solid' %}button{% else %}button button--secondary{% endif %}">
          {{ 'sections.featured_collection.view_all' | t: collection_name: collection.title | default: 'View all' }}
        </a>
      </div>
    {%- endif -%}
  </div>
</div>

{% schema %}
{
  "name": "Product Grid (Optimized)",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Featured Products" },
    { "type": "collection", "id": "collection", "label": "Collection" },
    { "type": "range", "id": "products_to_show", "min": 2, "max": 50, "step": 1, "label": "Products to show", "default": 8 },
    { "type": "range", "id": "products_per_row", "min": 2, "max": 5, "step": 1, "label": "Products per row (desktop)", "default": 4 },
    { "type": "header", "content": "Mobile Settings" },
    { "type": "select", "id": "mobile_columns", "label": "Mobile columns", "options": [ { "value": "1", "label": "1 column" }, { "value": "2", "label": "2 columns" } ], "default": "2" },
    { "type": "header", "content": "Product Information" },
    { "type": "checkbox", "id": "show_product_type", "label": "Show product type", "default": true },
    { "type": "checkbox", "id": "show_vendor", "label": "Show vendor", "default": false },
    { "type": "header", "content": "Badges" },
    { "type": "checkbox", "id": "show_badges", "label": "Show badges", "default": true },
    { "type": "select", "id": "badge_position", "label": "Badge position", "options": [ { "value": "image", "label": "On image" }, { "value": "top", "label": "Above title" }, { "value": "bottom", "label": "Below price" } ], "default": "image" },
    { "type": "header", "content": "Styling" },
    { "type": "color", "id": "type_color", "label": "Type color", "default": "#666666" },
    { "type": "select", "id": "type_style", "label": "Type style", "options": [ { "value": "text", "label": "Plain" }, { "value": "pill", "label": "Pill" }, { "value": "underline", "label": "Underlined" } ], "default": "text" },
    { "type": "color", "id": "type_bg_color", "label": "Pill background", "default": "#f5f5f5" },
    { "type": "header", "content": "View All" },
    { "type": "checkbox", "id": "show_view_all", "label": "Enable 'View all'", "default": false },
    { "type": "select", "id": "view_all_style", "label": "Button style", "options": [ { "value": "link", "label": "Link" }, { "value": "outline", "label": "Outline" }, { "value": "solid", "label": "Solid" } ], "default": "solid" },
    { "type": "color_scheme", "id": "view_all_color_scheme", "label": "Color scheme", "default": "scheme-1" }
  ],
  "presets": [ { "name": "Product Grid (Optimized)" } ]
}
{% endschema %}